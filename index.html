<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Nauka czytania</title>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2654167674032555"
     crossorigin="anonymous"></script>

<style>
    body {
        font-family: sans-serif;
        padding: 20px;
        line-height: 1.5;
    }

    #controls button,
    #loadControls button {
        font-size: 18px;
        margin: 5px;
        padding: 8px 16px;
        cursor: pointer;
    }

    .word-block {
        display: inline-block;
        margin: 20px 25px 30px 0;
        vertical-align: top;
    }

    .word-play button {
        height: 20px;
        border: none;
        background: #ddd;
        cursor: pointer;
        display: block;
    }

    .letters-row button {
        font-size: 28px;
        margin-right: 6px;
        margin-bottom: 3px;
        padding: 10px 0;
        cursor: pointer;
        border: 2px solid #444;
        width: 50px;
        text-align: center;
    }

    .syl-row button {
        height: 14px;
        margin-right: 6px;
        border: none;
        cursor: pointer;
        display: inline-block;
    }

    #wordsContainer {
        margin-top: 10px;
    }

    textarea {
        font-family: inherit;
    }
</style>
</head>
<body>

<h2>Nauka czytania – zdania, litery, sylaby</h2>
<h3>Dźwięki sylab i liter mogą być inne na urządzeniach, jest to zależne od używanego syntezatora</h3>
<h3>Najlepszy efekt można osiągnąć syntezatorem RH-Voice Alicja: https://rhvoice.org/installation/</h3>

<div id="loadControls">
    <input type="file" id="fileInput"><br><br>

    <textarea id="textInput" rows="4" cols="70"
              placeholder="Wpisz tekst tutaj..."></textarea><br><br>

    <button onclick="loadText()">Załaduj tekst</button>
</div>

<br>

<label for="phoneticMode">Tryb fonetyczny:</label>
<select id="phoneticMode">
    <option value="standard">Standardowy</option>
    <option value="phonetic">Fonetyczny </option>
</select>

<hr>

<div id="wordsContainer"></div>

<div id="controls">
    <button onclick="prevSentence()">Poprzednie zdanie</button>
    <button onclick="nextSentence()">Następne zdanie</button>
</div>

<script>
// --- PARAMETRY ---
const LETTER_WIDTH = 50;
const LETTER_GAP   = 6;

const punctuation = [".", ",", "!", "?", ":", ";", "…", "—", "-", "\"", "'", "”", "„"];

const digraphs = {
    "sz": "szy",
    "cz": "czy",
    "rz": "rzy",
    "ch": "hy"
};

// --- MAPY FONETYCZNE ---
const phoneticMaps = {
    standard: {},

    phonetic: {
        "A": "a",  "Ą": "ą",
        "B": "by",
        "C": "cy",  "Ć": "ci",
        "D": "dy",
        "E": "e",  "Ę": "ę",
        "F": "fy",
        "G": "gy",
        "H": "hy",
        "I": "i",
        "J": "ji",
        "K": "ky",
        "L": "ly",  "Ł": "ły",
        "M": "my",
        "N": "ny",  "Ń": "ni",
        "O": "o",  "Ó": "u",
        "P": "py",
        "Q": "ky",
        "R": "ry",
        "S": "sy",  "Ś": "si",
        "T": "ty",
        "U": "u",
        "V": "wy",
        "W": "wy",
        "X": "ksy",
        "Y": "igrek",
        "Z": "zy",  "Ż": "ży", "Ź": "źi"
    }
};

const specialSyllables = {
    "zi": "źi",
    "ci": "ći",
    "si": "śi",
    "ni": "ńi"
};

const vowels = ["a","ą","e","ę","i","o","ó","u","y"];

const prefixes = [
    "przed","prze","przy",
    "pod","nad","roz","bez",
    "wy","za","na","od","ob",
    "u"
];

const validOnsets = [
    "p","b","t","d","k","g","f","w","s","z","m","n","l","r",
    "sz","cz","rz","ch",
    "pl","bl","kl","gl","fl","wl",
    "pr","br","tr","dr","kr","gr","fr","wr",
    "sm","sn","zm","zn","mn"
];

// --- GŁOSY ---
let voices = [];

if ("speechSynthesis" in window) {
    function loadVoices() {
        voices = speechSynthesis.getVoices();
        if (!voices.length) setTimeout(loadVoices, 100);
    }
    loadVoices();
} else {
    alert("Twoja przeglądarka nie obsługuje syntezy mowy.");
}

// --- ZMIENNE ---
let sentences = [];
let currentIndex = 0;

// --- WCZYTYWANIE PLIKU ---
document.getElementById("fileInput").addEventListener("change", function() {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => processText(e.target.result);
    reader.readAsText(file, "UTF-8");
});

// --- WCZYTYWANIE TEKSTU ---
function loadText() {
    const text = document.getElementById("textInput").value.trim();
    if (text.length > 0) processText(text);
}

// --- PRZETWARZANIE TEKSTU ---
function processText(text) {
    sentences = text
        .replace(/\n/g, " ")
        .match(/[^.!?]+[.!?]?/g) || [];

    currentIndex = 0;
    showSentence();
}

// --- PODZIAŁ NA JEDNOSTKI ---
function splitIntoUnits(word) {
    const units = [];
    let i = 0;
    const lower = word.toLowerCase();

    while (i < word.length) {

        if (punctuation.includes(word[i])) {
            units.push(word[i]);
            i++;
            continue;
        }

        const pair = lower[i] + (lower[i+1] || "");

        if (digraphs[pair]) {
            units.push(word.slice(i, i+2));
            i += 2;
            continue;
        }

        if (["ci","si","zi","ni"].includes(pair) && vowels.includes((lower[i+2] || ""))) {
            units.push(word.slice(i, i+2));
            i += 2;
            continue;
        }

        if (["au","eu"].includes(pair)) {
            units.push(word.slice(i, i+2));
            i += 2;
            continue;
        }

        units.push(word[i]);
        i++;
    }

    return units;
}

// --- SYLABIZACJA ---
function syllabify(word) {
    const lower = word.toLowerCase();

    for (const pref of prefixes) {
        if (lower.startsWith(pref) && lower.length > pref.length + 1) {
            const rest = word.slice(pref.length);
            return [word.slice(0, pref.length), ...syllabify(rest)];
        }
    }

    const units = splitIntoUnits(word);
    const unitsLower = units.map(u => u.toLowerCase());

    const vowelIdx = [];
    for (let i = 0; i < unitsLower.length; i++) {
        if (vowels.includes(unitsLower[i])) vowelIdx.push(i);
    }

    if (vowelIdx.length <= 1) return [word];

    const syl = [];
    let start = 0;

    for (let v = 0; v < vowelIdx.length - 1; v++) {
        const v1 = vowelIdx[v];
        const v2 = vowelIdx[v + 1];

        if (v2 === v1 + 1) continue;

        const between = unitsLower.slice(v1 + 1, v2);
        let cut = 0;

        if (between.length === 1) cut = 0;
        else if (between.length === 2) {
            const c2 = between[1];
            cut = validOnsets.includes(c2) ? 1 : 0;
        }
        else if (between.length >= 3) {
            const last2 = between.slice(-2).join("");
            if (between[between.length - 2] === between[between.length - 1]) {
                cut = between.length - 1;
            } else if (validOnsets.includes(last2)) {
                cut = between.length - 2;
            } else {
                cut = between.length - 1;
            }
        }

        const end = v1 + 1 + cut;
        syl.push(units.slice(start, end).join(""));
        start = end;
    }

    syl.push(units.slice(start).join(""));
    return syl;
}

// --- MAPA FONETYCZNA ---
function applyPhoneticMap(unit) {
    const mode = document.getElementById("phoneticMode").value;
    const map = phoneticMaps[mode];

    const lower = unit.toLowerCase();
    const upper = unit.toUpperCase();

    return (
        specialSyllables[lower] ||
        digraphs[lower] ||
        map[upper] ||
        lower
    );
}

// --- MÓWIENIE JEDNOSTKI ---
function speakUnit(unit) {
    if (punctuation.includes(unit)) return;

    const sound = applyPhoneticMap(unit);

    const utter = new SpeechSynthesisUtterance(sound);
    utter.lang = "pl-PL";

    const polishVoice = voices.find(v => v.lang.startsWith("pl"));
    if (polishVoice) utter.voice = polishVoice;

    speechSynthesis.cancel();
    speechSynthesis.speak(utter);
}

// --- MÓWIENIE WYRAZU ---
function speakWord(word) {
    const utter = new SpeechSynthesisUtterance(word);
    utter.lang = "pl-PL";

    const polishVoice = voices.find(v => v.lang.startsWith("pl"));
    if (polishVoice) utter.voice = polishVoice;

    speechSynthesis.cancel();
    speechSynthesis.speak(utter);
}

// --- GENEROWANIE ZDANIA ---
function showSentence() {
    const container = document.getElementById("wordsContainer");
    container.innerHTML = "";

    if (!sentences.length) return;

    const sentence = sentences[currentIndex].trim();
    const rawWords = sentence.split(" ");

    rawWords.forEach(raw => {
        if (!raw) return;

        const block = document.createElement("div");
        block.className = "word-block";

        const syls = syllabify(raw);

        const allUnits = syls.flatMap(s => splitIntoUnits(s));
        const totalUnits = allUnits.length;

        const playDiv = document.createElement("div");
        playDiv.className = "word-play";

        const playBtn = document.createElement("button");
        const wordWidth = totalUnits * LETTER_WIDTH + (totalUnits - 1) * LETTER_GAP;
        playBtn.style.width = wordWidth + "px";
        playBtn.onclick = () => speakWord(raw);

        playDiv.appendChild(playBtn);
        block.appendChild(playDiv);

        const lettersDiv = document.createElement("div");
        lettersDiv.className = "letters-row";

        syls.forEach((syl, sylIndex) => {
            const units = splitIntoUnits(syl);
            const color = punctuation.includes(syl) ? "black" :
                          (sylIndex % 2 === 0 ? "red" : "black");

            units.forEach(u => {
                const btn = document.createElement("button");
                btn.textContent = u;
                btn.style.color = punctuation.includes(u) ? "black" : color;
                btn.onclick = () => speakUnit(u);
                lettersDiv.appendChild(btn);
            });
        });

        block.appendChild(lettersDiv);

        const sylDiv = document.createElement("div");
        sylDiv.className = "syl-row";

        syls.forEach((syl, i) => {
            const units = splitIntoUnits(syl);
            const unitCount = punctuation.includes(syl) ? 1 : units.length;

            const sylWidth = unitCount * LETTER_WIDTH + (unitCount - 1) * LETTER_GAP;

            const btn = document.createElement("button");
            btn.style.width = sylWidth + "px";
            btn.style.background = punctuation.includes(syl)
                ? "gray"
                : (i % 2 === 0 ? "red" : "black");

            btn.onclick = () => speakUnit(syl);
            sylDiv.appendChild(btn);
        });

        block.appendChild(sylDiv);

        container.appendChild(block);
    });
}

// --- NAWIGACJA ---
function nextSentence() {
    if (currentIndex < sentences.length - 1) {
        currentIndex++;
        showSentence();
    }
}

function prevSentence() {
    if (currentIndex > 0) {
        currentIndex--;
        showSentence();
    }
}
</script>

</body>
</html>